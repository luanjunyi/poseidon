#! /usr/bin/python
# -*- coding: utf-8 -*-
import sys, os, re, traceback
import MySQLdb
sys.path.append(os.path.dirname(os.path.abspath(__file__)) + '/../../') # Paracode root
from taras import taras
from util.log import _logger

# Init MySQL connection
conn = MySQLdb.connect(host = 'yhhd',
                       user = 'taras',
                       passwd = 'admin123',
                       db = 'taras')
cursor = conn.cursor(MySQLdb.cursors.DictCursor)
cursor.execute('set names utf8')
conn.commit()
cursor.execute("select user, max(collect_date) as date from user_statistic group by user")

daemon = taras.WeiboDaemon(noselenium=True)
for row in cursor.fetchall():
    user = row['user']
    parse = re.search(r'.+#(.+)#(.+)#http://weibo.com/([0-9]+)', user)
    if parse == None:
        raise Exception("")
    email = parse.group(1)
    passwd = parse.group(2)
    uid = parse.group(3)
    try:
        api = daemon.get_api_on_the_fly(email, passwd)
        _logger.debug("good: (%s, %s) %s" % (email, passwd, api.me().name))
    except Exception, err:
        _logger.debug("bad: (%s, %s) %s" % (email, passwd, err))
daemon.shutdown()

    

